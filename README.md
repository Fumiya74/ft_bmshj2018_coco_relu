# ft_bmshj2018_coco_relu

**COCO2017 (224Ã—224 crops) ã‚’ç”¨ã„ã¦ CompressAI ã® `bmshj2018_factorized` ã® GDN/IGDN ã‚’ ReLU ã«ç½®æ›ã—ã€  
å†æ§‹æˆå“è³ªï¼ˆL1 + (1 âˆ’ MSâ€‘SSIM)ï¼‰ã§ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã™ã‚‹ãƒ¬ã‚·ãƒ”**ã€‚  
æ—¢å­˜ã®å®Ÿè¡Œãƒ•ãƒ­ãƒ¼ã¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆï¼ˆ`scripts/` ã§ãƒ‡ãƒ¼ã‚¿æº–å‚™ â†’ `src/` ã®å­¦ç¿’ã‚¹ã‚¯ãƒªãƒ—ãƒˆ â†’ `checkpoints/` ä¿å­˜ â†’ `recon/` ã«å†æ§‹æˆ PNG å‡ºåŠ›ï¼‰ã‚’è¸è¥²ã—ã¦ã„ã¾ã™ã€‚

> âš ï¸ æ³¨æ„: GDN/IGDN ã¯**å¯é€†æ€§ã‚„ã‚²ã‚¤ãƒ³æ­£è¦åŒ–**ã®ãŸã‚ã«è¨­è¨ˆã•ã‚ŒãŸå±¤ã§ã‚ã‚Šã€ReLU ã«å˜ç´”ç½®æ›ã™ã‚‹ã¨ RD ç‰¹æ€§ã‚’å´©ã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚  
> æœ¬ãƒ¬ã‚·ãƒ”ã¯ **ãƒ‡ã‚³ãƒ¼ãƒ€ï¼ˆã¾ãŸã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€/å…¨ä½“ï¼‰ã‚’å†å­¦ç¿’**ã—ã€ç”»è³ªé¢ã§ã®ãƒ•ã‚£ãƒƒãƒˆã‚’ç‹™ã†å®Ÿé¨“ç”¨æ§‹æˆã§ã™ã€‚  
> é€Ÿåº¦ã‚„ NPU äº’æ›æ€§ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã®åŸºç›¤ã¨ã—ã¦æ´»ç”¨ã—ã¦ãã ã•ã„ã€‚

---

## 1. ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
python -m venv .venv && source .venv/bin/activate   # Windows: .venv\Scripts\activate
pip install --upgrade pip
pip install -r requirements.txt
```

---

## 2. ãƒ‡ãƒ¼ã‚¿æº–å‚™ï¼ˆ224Ã—224 ã‚¯ãƒ­ãƒƒãƒ—ï¼‰

COCO2017 ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ï¼ˆ`train2017/` ã¨ `val2017/` ãŒå­˜åœ¨ï¼‰ãªã‚‰ã€æ¬¡ã§ 224Ã—224 ã‚¯ãƒ­ãƒƒãƒ—æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

```bash
python -m scripts.coco_prepare     --coco_dir /path/to/coco2017     --out_dir  /path/to/coco224     --include_val true
```

ç”Ÿæˆå¾Œã®æ§‹æˆä¾‹ï¼š

```text
/path/to/coco224/
  â”œâ”€ train/  *.jpg (224x224)
  â””â”€ val/    *.jpg (224x224)
```

> ğŸ’¡ é«˜é€ŸåŒ–ãƒ»å†ç¾æ€§ã®ãŸã‚ã«**äº‹å‰ã‚¯ãƒ­ãƒƒãƒ—ç‰ˆã‚’æ¨å¥¨**ã—ã¾ã™ã€‚ã‚ªãƒ³ã‚¶ãƒ•ãƒ©ã‚¤ã®ãƒªã‚µã‚¤ã‚º/ã‚¯ãƒ­ãƒƒãƒ—ã‚‚å¯èƒ½ã§ã™ãŒã€I/O ãŒå®‰å®šã™ã‚‹äº‹å‰ç‰ˆãŒä¾¿åˆ©ã§ã™ã€‚

---

## 3. å­¦ç¿’ï¼ˆReLU ç½®æ›ãƒ¢ãƒ‡ãƒ«ã®ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ï¼‰

```bash
python -m src.train_finetune_relu     --coco_dir /path/to/coco224     --use_prepared true     --quality 8     --epochs 10     --batch_size 16     --lr 1e-4     --alpha_l1 0.4     --train_parts all     --recon_every 2     --recon_count 16     --save_dir ./checkpoints     --recon_dir ./recon
```

### ä¸»ãªå¼•æ•°
- `--quality`: CompressAI ã®ç”»è³ªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ0ã€œ8ï¼‰ã€‚
- `--train_parts`: å­¦ç¿’å¯¾è±¡ã‚’é¸æŠ  
  - `decoder`: ãƒ‡ã‚³ãƒ¼ãƒ€å´ã®ã¿å­¦ç¿’  
  - `encoder`: ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€å´ã®ã¿å­¦ç¿’  
  - `decoder+encoder`: ä¸¡æ–¹å­¦ç¿’  
  - `all` (Default): å…¨ä½“å­¦ç¿’
- `--alpha_l1`: æå¤±é–¢æ•°ã® L1 é‡ã¿ã€‚`loss = alpha*L1 + (1-alpha)*(1-MSâ€‘SSIM)`
- `--use_prepared`: `true` ã®å ´åˆã€äº‹å‰ã‚¯ãƒ­ãƒƒãƒ—æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã€‚
- `--recon_every`: ä½•ã‚¨ãƒãƒƒã‚¯ã”ã¨ã«å†æ§‹æˆç”»åƒã‚’ä¿å­˜ã™ã‚‹ã‹ã€‚
- `--recon_count`: å†æ§‹æˆã«ä½¿ã† val ã‚µãƒ³ãƒ—ãƒ«æšæ•°ã€‚
- `--recon_dir`: å†æ§‹æˆç”»åƒã®ä¿å­˜å…ˆã€‚

### W&B ãƒ­ã‚°åˆ©ç”¨
```bash
WANDB_PROJECT=bmshj2018_relu wandb login  # åˆå›ã®ã¿
python -m src.train_finetune_relu ... --wandb true
```

- `save_dir/wandb_run_id.txt` ã« run_id ãŒä¿å­˜ã•ã‚Œã€`--resume` æ™‚ã«åŒã˜ run ã«ç¶šãã¾ã™ã€‚
- run_id ã«ã¯ `train_parts` æƒ…å ±ãŒä»˜ä¸ã•ã‚Œã‚‹ãŸã‚ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ä¸Šã§ã©ã®éƒ¨ä½ã‚’å­¦ç¿’ã—ãŸ run ã‹ä¸€ç›®ã§åˆ¤åˆ¥å¯èƒ½ã§ã™ã€‚

---

## 4. è©•ä¾¡

```bash
python -m src.eval     --coco_dir /path/to/coco224     --use_prepared true     --checkpoint ./checkpoints/best_msssim.pt
```

å‡ºåŠ›: å¹³å‡ **PSNR** / **MSâ€‘SSIM**

---

## 5. ä»•çµ„ã¿ã®æ¦‚è¦

- `compressai.zoo.bmshj2018_factorized(quality, pretrained=True)` ã‚’ãƒ­ãƒ¼ãƒ‰ã€‚
- `replace_gdn_with_relu(model, mode)` ã«ã‚ˆã‚Šã€**å­¦ç¿’å¯¾è±¡ã«é¸ã°ã‚ŒãŸéƒ¨åˆ†ã ã‘** GDN/IGDN ã‚’ ReLU ã«ç½®æ›ã€‚
  - ä¾‹: `--train_parts decoder` â†’ ãƒ‡ã‚³ãƒ¼ãƒ€å´ã®ã¿ ReLU ã«ç½®æ›ã—å­¦ç¿’ã€ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€å´ã¯ GDN ã®ã¾ã¾å›ºå®šã€‚
- `set_trainable_parts(model, mode)` ã§æ›´æ–°å¯¾è±¡ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’é™å®šã€‚
- æå¤±é–¢æ•°: `alpha * L1 + (1 - alpha) * (1 - MSâ€‘SSIM)`ï¼ˆæ—¢å®š `alpha=0.4`ï¼‰ã€‚
- å†æ§‹æˆç”»åƒã¯ã‚¨ãƒãƒƒã‚¯ã”ã¨ã« `recon/` ä»¥ä¸‹ã« PNG å‡ºåŠ›ã—ã€W&B ã«ã¯ã‚°ãƒªãƒƒãƒ‰å½¢å¼ã§ãƒ­ã‚°ã€‚

---

## 6. æ³¨æ„ç‚¹ / Tips

- ReLU ç½®æ›ç›´å¾Œã¯å­¦ç¿’ãŒä¸å®‰å®šã«ãªã‚Šã‚„ã™ã„ãŸã‚ **å­¦ç¿’ç‡ã¯å°ã•ã‚ï¼ˆ1eâ€‘4ï¼‰** ã‚’æ¨å¥¨ã€‚
- `decoder+encoder` ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨æ”¹å–„ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ãŒã€ç™ºæ•£ã‚„éå­¦ç¿’ã®ãƒªã‚¹ã‚¯ã‚ã‚Šã€‚
- I/O è² è·ãŒé«˜ã„ç’°å¢ƒã§ã¯ `--recon_count 8` ç¨‹åº¦ã«æ¸›ã‚‰ã™ã¨å®‰å®šã€‚
- ã‚ªãƒ³ã‚¶ãƒ•ãƒ©ã‚¤å‰å‡¦ç†ã‚’ä½¿ã†å ´åˆã¯ `--use_prepared false --input_size 224` ã‚’æŒ‡å®šã€‚

---

## 7. ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã¨ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ

- æœ¬ãƒ¬ã‚·ãƒ”ã¯ç ”ç©¶ãƒ»å®Ÿé¨“ç›®çš„ã§ã®åˆ©ç”¨ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚  
- å…ƒãƒ¢ãƒ‡ãƒ«ãƒ»ã‚³ãƒ¼ãƒ‰ã¯ [CompressAI](https://github.com/InterDigitalInc/CompressAI) ã® `bmshj2018_factorized` ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚